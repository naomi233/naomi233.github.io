---
title: Gitea + Drone CI 实现 DevOps 自动化部署 CI/CD
category: 踩坑记录
tag:
  - Docker
date: 2023-10-05
---

Gitea 作为代码仓库，Drone CI 作为持续集成工具，实现轻量级的 DevOps 自动化部署 CI/CD。

使用了 docker runner 来执行构建任务，通过自己编写 `.drone.yml`，可以在不同的容器镜像中执行命令。

## 服务部署

服务使用 `docker compose` 来管理

```env
# .env

# Drone CI 通信 Gitea 应用配置
GITEA_CLIENT_ID=

GITEA_CLIENT_SECRET=
```

```yml
# docker-compose.yml
services:
  gitea:
    image: gitea/gitea:1-linux-amd64
    container_name: gitea
    environment:
      - TZ=Asia/Shanghai
      - USER_UID=1000
      - USER_GID=1000
    restart: always
    volumes:
      - giteadata:/data

  drone-server:
    image: drone/drone:2
    container_name: drone-server
    restart: always
    volumes:
      - dronedata:/data
    environment:
      - DRONE_GITEA_SERVER=http://gitea
      - DRONE_GITEA_CLIENT_ID=${GITEA_CLIENT_ID}
      - DRONE_GITEA_CLIENT_SECRET=${GITEA_CLIENT_SECRET}
      - DRONE_RPC_SECRET=f235f1e8f4ed4e6a79244785beee3810
      - DRONE_USER_CREATE=admin:true

  drone-runner:
    image: drone/drone-runner-docker:1
    container_name: drone-runner
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_RPC_PROTO=http
      - DRONE_RPC_HOST=drone-server
      - DRONE_RPC_SECRET=f235f1e8f4ed4e6a79244785beee3810
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_RUNNER_NAME=my-first-runner

volumes:
  giteadata:
    driver: local
  dronedata:
    driver: local
```

## 示例配置

下面是一个示例的 `.drone.yml` 配置文件，使用 pnpm 构建 Vue.js 项目并部署到服务器 /home/wwwroot/dist 路径上。

```yml
# .drone.yml

kind: pipeline
type: docker
name: Docs deploy

trigger:
  branch:
    - master

volumes:
  - name: deploy
    host:
      path: /home/wwwroot/dist

steps:
  - name: Build & Deploy
    image: gplane/pnpm:9-node20
    environment:
      NODE_OPTIONS: --max_old_space_size=2048
    volumes:
      - name: deploy
        path: /drone/src/dist
    commands:
      - pnpm config set registry https://mirrors.tencent.com/npm/
      - pnpm config list
      - pnpm install --frozen-lockfile
      - pnpm run build
```

## 参考

- <https://docs.drone.io/server/provider/gitea/>
- <https://docs.drone.io/runner/overview/>
- <https://docs.drone.io/quickstart/docker/>
