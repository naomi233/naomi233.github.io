---
title: WatchDucker ä½¿ç”¨æŒ‡å—
tag:
  - Docker
---

ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„ Docker å®¹å™¨é•œåƒæ›´æ–°æ£€æŸ¥å’Œè‡ªåŠ¨æ›´æ–°å·¥å…·ã€‚

[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)

## âœ¨ ç‰¹æ€§

- ğŸ” **æ™ºèƒ½æ£€æŸ¥**: è‡ªåŠ¨æ£€æµ‹å®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
- ğŸ·ï¸ **æ ‡ç­¾é©±åŠ¨**: é€šè¿‡ `watchducker.update=true` æ ‡ç­¾è‡ªåŠ¨ç®¡ç†éœ€è¦æ›´æ–°çš„å®¹å™¨
- â° **å®šæ—¶æ‰§è¡Œ**: æ”¯æŒä½¿ç”¨ cron è¡¨è¾¾å¼è¿›è¡Œå®šæ—¶æ£€æŸ¥
- ğŸ”„ **è‡ªåŠ¨æ›´æ–°**: æ£€æµ‹åˆ°æ›´æ–°åå¯è‡ªåŠ¨é‡å¯å®¹å™¨ä½¿ç”¨æ–°é•œåƒ
- ğŸš« **çµæ´»æ§åˆ¶**: æä¾›åªæ£€æŸ¥ä¸é‡å¯çš„é€‰é¡¹
- âœ¨ **å®æ—¶åé¦ˆ**: æ£€æŸ¥è¿‡ç¨‹ä¸­æä¾›å®æ—¶è¿›åº¦å’Œç»“æœè¾“å‡º
- ğŸ³ **Docker åŸç”Ÿ**: å®Œå…¨åŸºäº Docker APIï¼Œæ— éœ€é¢å¤–ä¾èµ–
- âš™ï¸ **æ— éœ€ä»£ç†**: å¤ç”¨ç°æœ‰ Docker é…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®è®¤è¯å’Œä»£ç†ã€[åŠ é€Ÿé•œåƒæº](https://github.com/dongyubin/DockerHub)
- ğŸ“¢ **å¤šå¹³å°é€šçŸ¥**: æ”¯æŒ Telegramã€å¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ã€é‚®ä»¶ç­‰ 15+ ç§é€šçŸ¥æ–¹å¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

### äºŒè¿›åˆ¶å®‰è£…

ä» [Releases é¡µé¢](https://github.com/naomi233/watchducker/releases) ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

### Docker é•œåƒ

```bash
docker pull naomi233/watchducker:latest
```

### æºç ç¼–è¯‘

```bash
git clone https://github.com/naomi233/watchducker.git
cd watchducker
go build -o watchducker .
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### Docker

```bash
# æ£€æŸ¥æŒ‡å®šå®¹å™¨ä¸€æ¬¡
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --once nginx redis mysql
# æ£€æŸ¥æ‰€æœ‰å¸¦æœ‰æ›´æ–°æ ‡ç­¾çš„å®¹å™¨ä¸€æ¬¡
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --label --once
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨ä¸€æ¬¡ï¼Œæ›´æ–°åæ¸…ç†æ‚¬ç©ºé•œåƒ
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --all --clean --once
# åªæ›´æ–°é•œåƒï¼Œä¸é‡å¯å®¹å™¨
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --no-restart --once nginx redis
# ä½¿ç”¨æ ‡ç­¾æ¨¡å¼ï¼ŒåŒæ—¶é˜²æ­¢è‡ªåŠ¨é‡å¯
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --label --no-restart --once
# æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ‰€æœ‰æ ‡ç­¾å®¹å™¨
docker run --name watchducker -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --cron "0 2 * * *" --label
# æ¯30åˆ†é’Ÿæ£€æŸ¥æŒ‡å®šå®¹å™¨
docker run --name watchducker -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --cron "*/30 * * * *" nginx redis
# æ¯å¤©æ‰§è¡Œï¼Œåªæ£€æŸ¥ä¸é‡å¯
docker run --name watchducker -v /var/run/docker.sock:/var/run/docker.sock naomi233/watchducker:latest watchducker --cron "@daily" --no-restart nginx

# ä½¿ç”¨é€šçŸ¥åŠŸèƒ½ï¼ˆæ–¹å¼ä¸€ï¼šæŒ‚è½½é…ç½®æ–‡ä»¶ï¼‰
docker run --name watchducker -v /var/run/docker.sock:/var/run/docker.sock -v $(pwd)/push.yaml:/app/push.yaml naomi233/watchducker:latest watchducker --cron "0 2 * * *" --label

# ä½¿ç”¨é€šçŸ¥åŠŸèƒ½ï¼ˆæ–¹å¼äºŒï¼šç¯å¢ƒå˜é‡ï¼Œæ— éœ€æŒ‚è½½é…ç½®æ–‡ä»¶ï¼‰
docker run --name watchducker \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -e WATCHDUCKER_SETTING_PUSH_SERVER=telegram \
  -e WATCHDUCKER_TELEGRAM_API_URL=api.telegram.org \
  -e WATCHDUCKER_TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN \
  -e WATCHDUCKER_TELEGRAM_CHAT_ID=YOUR_CHAT_ID \
  naomi233/watchducker:latest watchducker --cron "0 2 * * *" --label
```

### å¯æ‰§è¡Œæ–‡ä»¶

```bash
# æ£€æŸ¥æŒ‡å®šå®¹å™¨ä¸€æ¬¡
watchducker --once nginx redis mysql
# æ£€æŸ¥æ‰€æœ‰å¸¦æœ‰æ›´æ–°æ ‡ç­¾çš„å®¹å™¨ä¸€æ¬¡
watchducker --label --once
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨ä¸€æ¬¡ï¼Œæ›´æ–°åæ¸…ç†æ‚¬ç©ºé•œåƒ
watchducker --all --clean --once
# åªæ›´æ–°é•œåƒï¼Œä¸é‡å¯å®¹å™¨
watchducker --no-restart --once nginx redis
# ä½¿ç”¨æ ‡ç­¾æ¨¡å¼ï¼ŒåŒæ—¶é˜²æ­¢è‡ªåŠ¨é‡å¯
watchducker --label --no-restart --once
# æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥æ‰€æœ‰æ ‡ç­¾å®¹å™¨
watchducker --cron "0 2 * * *" --label
# æ¯30åˆ†é’Ÿæ£€æŸ¥æŒ‡å®šå®¹å™¨
watchducker --cron "*/30 * * * *" nginx redis
# æ¯å¤©æ‰§è¡Œï¼Œåªæ£€æŸ¥ä¸é‡å¯
watchducker --cron "@daily" --no-restart nginx
# ä½¿ç”¨ --label-reversed å‚æ•°æ£€æŸ¥æ‰€æœ‰å®¹å™¨ï¼Œæ’é™¤å¸¦æœ‰ watchducker.update=true æ ‡ç­¾çš„å®¹å™¨
watchducker --label-reversed --once

# ä½¿ç”¨é€šçŸ¥åŠŸèƒ½ï¼ˆéœ€è¦é…ç½® push.yamlï¼‰
watchducker --cron "0 2 * * *" --label
```

### Docker Compose é…ç½®ç¤ºä¾‹

```yml
services:
  watchducker:
    image: naomi233/watchducker
    container_name: watchducker
    network_mode: bridge
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./push.yaml:/app/push.yaml # æŒ‚è½½é€šçŸ¥é…ç½®æ–‡ä»¶
    environment:
      - TZ=Asia/Shanghai
      - WATCHDUCKER_LOG_LEVEL=DEBUG
      - WATCHDUCKER_CRON=0 2 * * *
      - WATCHDUCKER_LABEL=true
```

## âš™ï¸ é…ç½®é€‰é¡¹

### å‘½ä»¤è¡Œå‚æ•°

- `--all`: æ£€æŸ¥æ‰€æœ‰å®¹å™¨ï¼ˆé»˜è®¤ä»…åŒ…å«è¿è¡Œä¸­çš„å®¹å™¨ï¼‰
- `--label`: æ£€æŸ¥å¸¦æœ‰ `watchducker.update=true` æ ‡ç­¾çš„å®¹å™¨
- `--label-reversed`: æ£€æŸ¥æ²¡æœ‰ `watchducker.update=true` æ ‡ç­¾çš„å®¹å™¨
- `--cron`: å®šæ—¶æ‰§è¡Œï¼Œä½¿ç”¨æ ‡å‡† [cron è¡¨è¾¾å¼](https://crontab.guru) æ ¼å¼ï¼Œé»˜è®¤å€¼ "0 2 \* \* \*"
- `--once`: åªæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥å’Œæ›´æ–°ï¼Œç„¶åé€€å‡º
- `--clean`: æ›´æ–°å®¹å™¨åè‡ªåŠ¨æ¸…ç†æ‚¬ç©ºé•œåƒ
- `--no-restart`: åªæ›´æ–°é•œåƒï¼Œä¸é‡å¯å®¹å™¨
- `--include-stopped`: åœ¨æ£€æŸ¥æ—¶åŒ…å«å·²åœæ­¢çš„å®¹å™¨
- `--disabled-containers`: æ’é™¤æŒ‡å®šçš„å®¹å™¨ï¼Œä¸è¿›è¡Œæ£€æŸ¥å’Œæ›´æ–°ï¼ˆæ”¯æŒé€—å·åˆ†éš”å¤šä¸ªå®¹å™¨ï¼‰
- å®¹å™¨åç§°åˆ—è¡¨

### é€šçŸ¥åŠŸèƒ½é…ç½®

WatchDucker æ”¯æŒåŒæ—¶ä½¿ç”¨å¤šç§é€šçŸ¥æ¸ é“ï¼Œå¯é€šè¿‡ `push.yaml` é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ã€‚

#### æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

```yaml
setting:
  push_server: "telegram" # æ¨é€æœåŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒå¤šæ¸ é“ ç”¨,åˆ†å¼€ï¼‰
  log_level: "DEBUG" # æ—¥å¿—çº§åˆ«ï¼šDEBUG/INFO/WARN/ERROR

telegram:
  api_url: "api.telegram.org" # Telegram APIåœ°å€ï¼ˆæ”¯æŒåä»£ï¼‰
  bot_token: "YOUR_BOT_TOKEN" # æœºå™¨äººToken
  chat_id: "YOUR_CHAT_ID" # èŠå¤©ID


# å…¶ä»–é€šçŸ¥æ–¹å¼é…ç½®...
```

#### æ–¹å¼äºŒï¼šç¯å¢ƒå˜é‡ï¼ˆæ— éœ€æŒ‚è½½é…ç½®æ–‡ä»¶ï¼‰

ç¯å¢ƒå˜é‡ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„å¯¹åº”å€¼ï¼Œæ ¼å¼ä¸º `WATCHDUCKER_` + é…ç½®è·¯å¾„ï¼ˆç”¨ä¸‹åˆ’çº¿è¿æ¥ï¼‰ï¼š

```bash
# åŸºç¡€é…ç½®
export WATCHDUCKER_SETTING_PUSH_SERVER="telegram,dingrobot"
export WATCHDUCKER_SETTING_LOG_LEVEL="INFO"

# Telegram é…ç½®
export WATCHDUCKER_TELEGRAM_API_URL="api.telegram.org"
export WATCHDUCKER_TELEGRAM_BOT_TOKEN="YOUR_BOT_TOKEN"
export WATCHDUCKER_TELEGRAM_CHAT_ID="YOUR_CHAT_ID"

# é’‰é’‰é…ç½®
export WATCHDUCKER_DINGROBOT_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=xxx"
export WATCHDUCKER_DINGROBOT_SECRET="SECxxx"
```

Docker Compose ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼š

```yml
services:
  watchducker:
    image: naomi233/watchducker
    container_name: watchducker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Asia/Shanghai
      - WATCHDUCKER_CRON=0 2 * * *
      - WATCHDUCKER_LABEL=true
      # é€šçŸ¥é…ç½®ï¼ˆæ— éœ€æŒ‚è½½ push.yamlï¼‰
      - WATCHDUCKER_SETTING_PUSH_SERVER=telegram
      - WATCHDUCKER_TELEGRAM_API_URL=api.telegram.org
      - WATCHDUCKER_TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN
      - WATCHDUCKER_TELEGRAM_CHAT_ID=YOUR_CHAT_ID
```

æ”¯æŒçš„é€šçŸ¥æœåŠ¡ï¼š

- **Telegram**: æœºå™¨äººæ¨é€
- **Server é…± (FTQQ)**: å¾®ä¿¡æ¨é€
- **PushPlus**: å¾®ä¿¡æ¨é€
- **CQHTTP**: QQ æ¨é€
- **SMTP**: é‚®ä»¶æ¨é€
- **ä¼ä¸šå¾®ä¿¡**: åº”ç”¨æ¶ˆæ¯å’Œç¾¤æœºå™¨äºº
- **PushDeer**: è‡ªå»ºæ¨é€æœåŠ¡
- **é’‰é’‰**: ç¾¤æœºå™¨äºº
- **é£ä¹¦**: ç¾¤æœºå™¨äºº
- **Bark**: iOS æ¨é€
- **Gotify**: è‡ªå»ºæ¨é€æœåŠ¡
- **IFTTT**: Webhook è§¦å‘
- **Webhook**: è‡ªå®šä¹‰ Webhook
- **Qmsg**: QQ æ¶ˆæ¯æ¨é€
- **Discord**: Webhook æ¨é€

### ç¯å¢ƒå˜é‡

```bash
# è®¾ç½®å®¹å™¨æ—¶åŒºï¼ˆé»˜è®¤ UTCï¼Œå¯æŒ‰éœ€è¦†ç›–ï¼‰
export TZ=Asia/Shanghai

# è®¾ç½®æ—¥å¿—çº§åˆ« (DEBUG/INFO/WARN/ERROR)
export WATCHDUCKER_LOG_LEVEL=DEBUG

# ç­‰åŒäº --all é€‰é¡¹
export WATCHDUCKER_ALL=true

# ç­‰åŒäº --label é€‰é¡¹
export WATCHDUCKER_LABEL=true

# ç­‰åŒäº --label-reversed é€‰é¡¹
export WATCHDUCKER_LABEL_REVERSED=true

# ç­‰åŒäº --cron é€‰é¡¹
export WATCHDUCKER_CRON="0 2 * * *"

# ç­‰åŒäº --clean é€‰é¡¹
export WATCHDUCKER_CLEAN=true

# ç­‰åŒäº --no-restart é€‰é¡¹
export WATCHDUCKER_NO_RESTART=true

# ç­‰åŒäº --include-stopped é€‰é¡¹
export WATCHDUCKER_INCLUDE_STOPPED=true

# ç­‰åŒäº --disabled-containers é€‰é¡¹
export WATCHDUCKER_DISABLED_CONTAINERS="container1,container2"
```

### æ—¶åŒºé…ç½®

å®¹å™¨é•œåƒé»˜è®¤æŒ‰ç…§ UTC è¿è¡Œã€‚åªéœ€é€šè¿‡æ ‡å‡† `TZ` ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `-e TZ=Asia/Shanghai`ï¼Œæˆ–åœ¨ Compose/ç¯å¢ƒé…ç½®ä¸­è®¾ç½® `TZ` ï¼‰å³å¯è®©å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ç›®æ ‡æ—¶åŒºï¼Œæ— éœ€é¢å¤–æŒ‚è½½ `/etc/localtime`ã€‚

### ä½¿ç”¨æ ‡ç­¾é©±åŠ¨æ›´æ–°

ä¸ºéœ€è¦è‡ªåŠ¨æ›´æ–°çš„å®¹å™¨æ·»åŠ æ ‡ç­¾ï¼š

```bash
docker run --name nginx --label watchducker.update=true nginx:latest
```

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```plain
watchducker/
â”œâ”€â”€ cmd/                    # å‘½ä»¤è¡Œå…¥å£
â”‚   â””â”€â”€ cmd.go               # ä¸»å‘½ä»¤é€»è¾‘
â”œâ”€â”€ internal/                 # å†…éƒ¨æ¨¡å—
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ checker.go         # é•œåƒæ£€æŸ¥å™¨
â”‚   â”‚   â””â”€â”€ operator.go      # å®¹å™¨æ“ä½œå™¨
â”‚   â”œâ”€â”€ docker/               # Docker API å°è£…
â”‚   â”‚   â”œâ”€â”€ client.go         # å®¢æˆ·ç«¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ container.go     # å®¹å™¨æœåŠ¡
â”‚   â”‚   â””â”€â”€ image.go          # é•œåƒæœåŠ¡
â”‚   â””â”€â”€ types/                 # ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ types.go
â”œâ”€â”€ pkg/                      # å¯å¤ç”¨çš„å…¬å…±åŒ…
â”‚   â”œâ”€â”€ config/                # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ config.go
â”‚   â”œâ”€â”€ logger/               # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ logger.go
â”‚   â”œâ”€â”€ notify/               # é€šçŸ¥ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ notify.go         # å¤šå¹³å°é€šçŸ¥æœåŠ¡
â”‚   â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ display.go         # æ˜¾ç¤ºè¾“å‡º
â”œâ”€â”€ main.go                    # ç¨‹åºå…¥å£
â”œâ”€â”€ push.yaml.example         # é€šçŸ¥é…ç½®ç¤ºä¾‹æ–‡ä»¶
```

### æ ¸å¿ƒç»„ä»¶

- **Checker**: é•œåƒæ£€æŸ¥å™¨ï¼Œè´Ÿè´£æ£€æŸ¥å®¹å™¨ä½¿ç”¨çš„é•œåƒæ˜¯å¦æœ‰æ›´æ–°
- **Operator**: å®¹å™¨æ“ä½œå™¨ï¼Œè´Ÿè´£å®¹å™¨çš„é‡å¯å’Œæ›´æ–°æ“ä½œ
- **ContainerService**: å®¹å™¨æœåŠ¡ï¼Œå°è£… Docker å®¹å™¨çš„æ“ä½œ
- **ImageService**: é•œåƒæœåŠ¡ï¼Œå°è£… Docker é•œåƒçš„æ£€æŸ¥é€»è¾‘
- **NotifyService**: é€šçŸ¥æœåŠ¡ï¼Œæ”¯æŒ 15+ ç§é€šçŸ¥æ–¹å¼æ¨é€æ›´æ–°ç»“æœ

## ğŸ”§ å¼€å‘

### ä¾èµ–è¦æ±‚

- Go 1.25 æˆ–æ›´é«˜ç‰ˆæœ¬
- Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆç”¨äºå®¹å™¨æ“ä½œï¼‰
- ç½‘ç»œè¿æ¥ï¼ˆç”¨äºé•œåƒä»“åº“è®¿é—®ï¼‰

### é¡¹ç›®æ„å»º

```bash
# å¼€å‘æ„å»º
go build -o watchducker .

# å¤šå¹³å°å‘å¸ƒï¼ˆä½¿ç”¨ GoReleaserï¼‰
goreleaser build --snapshot

# åˆ›å»º Docker é•œåƒ
goreleaser release --snapshot
```

## ğŸ“Š å·¥ä½œæµç¨‹

1. **å®¹å™¨å‘ç°**: æ ¹æ®å®¹å™¨åç§°æˆ–æ ‡ç­¾æŸ¥æ‰¾ç›¸å…³å®¹å™¨
2. **é•œåƒæ£€æŸ¥**: å¹¶å‘æ£€æŸ¥æ‰€æœ‰é•œåƒæ˜¯å¦æœ‰æ›´æ–°ç‰ˆæœ¬
3. **è‡ªåŠ¨æ›´æ–°**: åœæ­¢æ—§å®¹å™¨ â†’ åˆ é™¤æ—§å®¹å™¨ â†’ åˆ›å»ºæ–°å®¹å™¨ â†’ å¯åŠ¨æ–°å®¹å™¨

## ğŸ” å®‰å…¨æ€§

- åªå¯¹æŒ‡å®šæ ‡ç­¾çš„å®¹å™¨è¿›è¡Œæ“ä½œ
- æä¾›æ¸…æ™°çš„æ—¥å¿—è®°å½•æ‰€æœ‰æ“ä½œ
- æ”¯æŒåªæ£€æŸ¥æ¨¡å¼ï¼Œé¿å…æ„å¤–é‡å¯

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æƒé™é”™è¯¯**: ç¡®ä¿ç¨‹åºæœ‰è¶³å¤Ÿçš„æƒé™è®¿é—® Docker å®ˆæŠ¤è¿›ç¨‹
2. **ç½‘ç»œè¿æ¥**: æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥è®¿é—®é•œåƒä»“åº“
3. **å®¹å™¨çŠ¶æ€**: ç¡®ä¿ç›®æ ‡å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è°ƒè¯•æ—¥å¿—
export WATCHDUCKER_LOG_LEVEL=DEBUG
watchducker --label
```
